{"ast":null,"code":"var _jsxFileName = \"/Users/ducdoan2002/Desktop/chat-app/client/src/components/contexts/ConversationProvider.jsx\",\n    _s = $RefreshSig$(),\n    _s2 = $RefreshSig$();\n\nimport React, { useContext, useEffect, useCallback } from 'react';\nimport useLocalStorage from '../../customHooks/useLocalStorage';\nimport { useContacts } from './ContactsProvider';\nimport { useSocket } from '../SocketProvider';\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nconst ConversationContext = /*#__PURE__*/React.createContext(); //small custom Hook\n\nexport const useConversation = () => {\n  _s();\n\n  return useContext(ConversationContext);\n};\n\n_s(useConversation, \"gDsCjeeItUuvgOWf1v4qoK9RF6k=\");\n\nexport default function ConversationProvider(_ref) {\n  _s2();\n\n  let {\n    id,\n    children\n  } = _ref;\n  const [conversations, setConversations] = useLocalStorage('conversations', []);\n  const [selectedConversationIndex, setSelectedConversationIndex] = React.useState(0); //storing a new Contact the the state contacts\n\n  const createConversation = selectedUser => {\n    setConversations(prev => [...prev, {\n      selectedUser,\n      message: []\n    }]);\n  }; //get all contacts\n\n\n  const allContacts = useContacts(); //get the socket \n\n  const socket = useSocket(); //add new recipient property to each conversation in conversations\n\n  console.log(conversations);\n  const formatConversations = conversations.map((conver, index) => {\n    //format the contact to display on the page\n    const recipient = conver.selectedUser.map(user => {\n      const contact = allContacts.contacts.find(contact => {\n        if (contact.id === user) {\n          return contact;\n        }\n\n        ;\n      });\n      const name = contact ? contact.username : contact.id;\n      return {\n        id: contact.id,\n        username: name\n      };\n    }); //format the message to display on the page (add fromMe + senderName props to each message object)\n\n    const formatMessage = conver.message.map(mes => {\n      const contact = allContacts.contacts.find(contact => {\n        if (contact.id === mes.sender) {\n          return contact;\n        }\n\n        ;\n      });\n      const name = contact ? contact.username : mes.sender;\n      const fromMe = mes.sender === id;\n      return { ...mes,\n        senderName: name,\n        fromMe\n      };\n    }); //update old form message to new formatMessage\n\n    conver.message = formatMessage;\n    let selected = index === selectedConversationIndex;\n    return { ...conver,\n      recipient,\n      selected\n    };\n  }); //ultility:\n\n  const matchRecipient = (arr1, arr2) => {\n    arr1.sort();\n    arr2.sort();\n\n    if (arr1.length !== arr2.length) {\n      return false;\n    }\n\n    for (let i = 0; i < arr1.length; i++) {\n      if (arr1[i] !== arr2[i]) {\n        return false;\n      }\n    }\n\n    return true;\n  };\n\n  const addMessageToConversation = useCallback(_ref2 => {\n    let {\n      recipient,\n      text,\n      sender\n    } = _ref2;\n    //recipient = a list of user Id, text = text input,sender = user with current Id\n    setConversations(prev => {\n      let matchConversation = false; //each message just need the sender and the text content\n\n      const newMessage = {\n        sender,\n        text\n      };\n      let newConversations = conversations.map(conver => {\n        if (matchRecipient(conver.selectedUser, recipient)) {\n          matchConversation = true;\n          return { ...conver,\n            message: [...conver.message, newMessage]\n          };\n        }\n\n        return conver;\n      });\n\n      if (matchConversation) {\n        return newConversations;\n      } else {\n        return [...prev, {\n          recipient,\n          message: [newMessage]\n        }];\n      }\n    });\n  }, [conversations, setConversations]); //to control when to trigger socket on receive-message event\n\n  useEffect(() => {\n    if (!socket) return;\n    socket.on('receive-message', addMessageToConversation);\n    return () => {\n      //remove all listeners in this receive-message event\n      socket.off('receive-message');\n    };\n  }, [socket, addMessageToConversation]);\n\n  const sendMessage = (recipient, text) => {\n    socket.emit('send-message', {\n      recipient,\n      text\n    });\n    addMessageToConversation({\n      recipient,\n      text,\n      sender: id\n    });\n  }; //the final value that ConversationContext.Provider holds\n\n\n  const output = {\n    //all conversations\n    conversations: formatConversations,\n    //one selected conversation \n    selectedConversation: formatConversations[selectedConversationIndex],\n    //change the selected conversation\n    setSelectedConversationIndex,\n    //create new conversation\n    createConversation,\n    //to store a message to the conversation\n    sendMessage\n  };\n  return /*#__PURE__*/_jsxDEV(ConversationContext.Provider, {\n    value: output,\n    children: children\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 123,\n    columnNumber: 9\n  }, this);\n}\n\n_s2(ConversationProvider, \"d/Ca5ELcEu9sUfsI1GFxAhwCQCs=\", false, function () {\n  return [useLocalStorage, useContacts, useSocket];\n});\n\n_c = ConversationProvider;\n\nvar _c;\n\n$RefreshReg$(_c, \"ConversationProvider\");","map":{"version":3,"sources":["/Users/ducdoan2002/Desktop/chat-app/client/src/components/contexts/ConversationProvider.jsx"],"names":["React","useContext","useEffect","useCallback","useLocalStorage","useContacts","useSocket","ConversationContext","createContext","useConversation","ConversationProvider","id","children","conversations","setConversations","selectedConversationIndex","setSelectedConversationIndex","useState","createConversation","selectedUser","prev","message","allContacts","socket","console","log","formatConversations","map","conver","index","recipient","user","contact","contacts","find","name","username","formatMessage","mes","sender","fromMe","senderName","selected","matchRecipient","arr1","arr2","sort","length","i","addMessageToConversation","text","matchConversation","newMessage","newConversations","on","off","sendMessage","emit","output","selectedConversation"],"mappings":"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","sourcesContent":["import React, {useContext, useEffect, useCallback} from 'react';\nimport useLocalStorage from '../../customHooks/useLocalStorage';\nimport { useContacts } from './ContactsProvider';\nimport { useSocket } from '../SocketProvider';\n\nconst ConversationContext = React.createContext();\n\n//small custom Hook\nexport const useConversation = () => {\n    return useContext(ConversationContext);\n}\n\nexport default function ConversationProvider({id, children}) {\n    const [conversations, setConversations] = useLocalStorage('conversations', []);\n    const [selectedConversationIndex, setSelectedConversationIndex] = React.useState(0);\n    //storing a new Contact the the state contacts\n    const createConversation = (selectedUser) => {\n        setConversations(prev => [...prev, {selectedUser, message: []}]);\n    }\n    //get all contacts\n    const allContacts = useContacts();\n    //get the socket \n    const socket = useSocket();\n\n\n    //add new recipient property to each conversation in conversations\n    console.log(conversations);\n    const formatConversations = conversations.map((conver, index)=>{\n        //format the contact to display on the page\n        const recipient = conver.selectedUser.map((user)=>{\n            const contact = allContacts.contacts.find(contact => {\n                if (contact.id === user){\n                    return contact;\n                };\n            })\n            const name = contact ?  contact.username : contact.id;\n            return {id: contact.id, username: name};\n        })\n        //format the message to display on the page (add fromMe + senderName props to each message object)\n        const formatMessage = conver.message.map((mes)=>{\n            const contact = allContacts.contacts.find(contact => {\n                if (contact.id === mes.sender){\n                    return contact;\n                };\n            })\n            const name = contact ?  contact.username : mes.sender;\n            const fromMe = (mes.sender === id);\n            return {...mes, senderName: name, fromMe};\n        })\n        //update old form message to new formatMessage\n        conver.message = formatMessage;\n        let selected = (index === selectedConversationIndex);\n        return {...conver, recipient, selected};\n    });\n\n    //ultility:\n    const matchRecipient = (arr1, arr2) => {\n        arr1.sort();\n        arr2.sort();\n        if (arr1.length !== arr2.length){\n            return false;\n        }\n        for (let i = 0; i<arr1.length; i++){\n            if (arr1[i] !== arr2[i]){\n                return false;\n            }\n        }\n        return true;\n    }\n\n    const addMessageToConversation = useCallback(({recipient, text, sender}) => {\n        //recipient = a list of user Id, text = text input,sender = user with current Id\n        setConversations(prev => {\n            let matchConversation = false;\n            //each message just need the sender and the text content\n            const newMessage = {sender, text};\n            let newConversations = conversations.map((conver) => {\n                if (matchRecipient(conver.selectedUser, recipient)){\n                    matchConversation = true;\n                    return {...conver, message: [...conver.message, newMessage]}\n                }\n                return conver;\n            })\n            if (matchConversation){\n                return newConversations;\n            }\n            else{\n                return [...prev, {recipient, message: [newMessage]}]\n            }\n        })\n    }, [conversations, setConversations])\n    \n    //to control when to trigger socket on receive-message event\n    useEffect(() => {\n        if (!socket) return;\n        socket.on('receive-message', addMessageToConversation);\n        return () => {\n            //remove all listeners in this receive-message event\n            socket.off('receive-message');\n        };\n    }, [socket, addMessageToConversation]);\n\n    const sendMessage = (recipient,text) => {\n        socket.emit('send-message', {recipient, text});\n        addMessageToConversation({recipient, text, sender: id});\n    }\n\n    //the final value that ConversationContext.Provider holds\n    const output = {\n        //all conversations\n        conversations: formatConversations, \n        //one selected conversation \n        selectedConversation: formatConversations[selectedConversationIndex], \n        //change the selected conversation\n        setSelectedConversationIndex, \n        //create new conversation\n        createConversation,\n        //to store a message to the conversation\n        sendMessage\n    }\n\n    return (\n        <ConversationContext.Provider value={output}>\n            {children}\n        </ConversationContext.Provider>\n    )\n}\n"]},"metadata":{},"sourceType":"module"}